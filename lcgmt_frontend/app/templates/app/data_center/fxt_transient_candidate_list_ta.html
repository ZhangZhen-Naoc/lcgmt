{% extends 'app/base.html' %}
{% from 'bootstrap/pagination.html' import render_pagination %}
{% from 'bootstrap/nav.html' import render_breadcrumb_item %}

{% block title %}{{ _('Einstein Probe Time Domain Astronomical Information Center') }}{% endblock %}
{% block content %}
    <nav aria-label="breadcrumb" style="margin-bottom: 10px;">
      <ol class="breadcrumb">
        {% block bread %}
        {{ render_breadcrumb_item('main.index', _('Home')) }}
        {{ render_breadcrumb_item('data_center.source_candidate_list', _('TA Quick Tool (FXT)')) }}
        {% endblock %}
      </ol>
    </nav>
    <div id="spinner-div">
      Loading...
      <div class="spinner-border" role="status">
        <span class="sr-only">Loading...</span>
      </div>
    </div>
    <div class="card w-100">
      <div class="card-header bg-light ep-cardheader">
        <div class="card-header-title">{{_('FXT Transient Candidate Identification')}}</div>
      </div>
      {% include "app/data_center/components/src_obs_search_form.html"  %}
      
      </div>

      <div class="card w-100" style="margin-top: 20px">
  
        <div class="card-header bg-light ep-cardheader">
          <div class="card-header-title">Candidate List <span id="items"></span>
            <div style="float:right">
  

              <button class="btn ep_openBtn btn-sm" id="download_list"  >Export CSV</button>
            </div>
          </div>
        </div>
        <div class="card-body">
        <div id="result_tab" style="z-index: 50; width: 100%"></div>
        <div id="ta_table" style="z-index: 50; width: 100%"></div>
          <p>  Identification  Records </p>
            {% include 'app/data_center/components/ta_record.html' %}
           
      </div>
     
    </div>
    






<!--第一个表格：源列表相关代码-->
<script>
    

    function reportOnline()
    {
        
        $.post('{{url_for('.ta_enter')}}',data={"channel":"ihep"})
        setTimeout("reportOnline()", 1000*10) // 10s报告一次在线
    }
    reportOnline()


    data = []
    {% for row in sources %}
    
    {% set row_id = row.id|string %}
    {% set so_id = infoList[row_id]['so_id']%}
    data.push({
        "id":"{{row.id}}",
        "fxt_name":"{{row.ep_name}}",//读取的Fxt源表中的name
        "src_name":"{{row.name}}",
        "version": "{{row.detection.version}}",
        "target_name":"{{row.target_name}}",
        "obs_time":"{{row.detection.observation.obs_start.strftime('%Y-%m-%d %H:%M:%S')}}",
        "ra":{{"%.3f"%row.ra}},
        "dec":{{"%.3f"%row.dec}},
        "pos_err":{{"%.3f"%(row.pos_err*60)}},
        {% if so_id in comments %}
        
        "type":"{{comments[so_id]['type']}}",
        "classification":"{{comments[so_id]['classification']}}",
        "simbad_name":"{{comments[so_id]['simbad_name']}}",
        "ep_name":"{{comments[so_id]['ep_name']}}",
        "wxt_name":"{{comments[so_id]['wxt_name']}}",
        "comments":`{{comments[so_id]['comments']}}`,
        {% else %}
        "type":'',
        "classification":'',
        "simbad_name":'',
        "ep_name":'',
        "wxt_name":'',
        "comments":'',
        {% endif %}
        "ai_classification":"{{row.ai_classification}}",
        "ai_prob":"{{row.ai_prob}}",
        "url": `{{url_for('.fxt_src_detail',src_id=row.id)}}`,
       
        "records": "{{url_for('.ta_records',src_id=so_id)}}",//ta records 中的src id是来自sourceobservation表
        // reference 表记录
    
        {% if infoList[row_id]['ep_ref_ra'] %}
            "r_ra": {{"%.3f"%(infoList[row_id]['ep_ref_ra'])}},
            "r_dec": {{"%.3f"%(infoList[row_id]['ep_ref_dec'])}},
            "r_sep":null,
            "known_flux":{{"%.2e"%(infoList[row_id]['ref_flux'])}},
        {% else %}
            "r_ra": null,
            "r_dec": null,
            "r_sep":null,
            "known_flux":null,
        {% endif %}

        {% if infoList[row_id]['flux'] %}
        "flux":{{"%.2e"%(infoList[row_id]['flux'])}},
        {% else %}
        "flux":null,
        {% endif %}

      

        //历史统计相关记录
        "ratio_flux":null,
        "frac_flux":null,
        "so_id":{{so_id}}


    })
    {% endfor %}


    var table = new Tabulator("#ta_table", {
        // data: mergeSameObsId(res),
        data,
        selectable: 1,
        dataTree: true,
        index:"id",
        //   height: 520,
        pagination: "local",
        paginationSize: 15,
     
        paginationCounter: "rows",
        layout: "fitDataFill",
        initialSort: [{ column: "obs_time", dir: "desc" }],
        columns: [
        {
              formatter: "rownum",
              hozAlign: "center",
            },
        {
            title: "FXT Name", field: "fxt_name", sorter:"string", //should be fxt_name
            formatter: "link",
            formatterParams:{
                
                url: (cell)=>{
                    return cell.getData()['url']
                },
                target:"_blank",
            },
            
        },
        {title: "Obs", field: "src_name", sorter:"string"},

        // {title: "Version", field: "version", sorter:"string"},
        {title: "Target Name", field: "target_name", sorter:"string"},

        {title: "Obs Time (UT)", field: "obs_time", sorter:"string"},
        {title: "RA(J2000)", field: "ra", sorter:"number"},
        {title: "Dec(J2000)", field: "dec", sorter:"number"},
        {
                title: "",
                formatter: submitIdentificationIcon,
                width: 50,
                hozAlign: "center",
                tooltip: "Submit Identification",

                cellClick: function (e, cell) {
                  submitIdentification(cell.getRow().getData());
                },
                download: false,
        },
        {
                title: "",
                formatter: deliver2fxtsysIcon,
                width: 50,
                hozAlign: "center",
                tooltip: "Deliver Idenfication Results to FXT System",

                cellClick: function (e, cell) {
                  deliver2fxtsys(cell.getRow().getData());
                },
                download: false,
        },
        // {title: "Pos_E", field: "pos_err", sorter:"number"},
        {
            title: "Type", 
            field: "type", 
            sorter:"string", 
            editor:"list",
            editorParams:{
                values:trasient_type_values, clearable:true
            }, 
            headerFilter:true, 
            headerFilterParams:{
                values:trasient_type_values, 
                clearable:true
            }
        },
        {title: "Classification", field: "classification", sorter:"string", headerFilter: "input",editor:"input"},
        {title: "Common Name", field: "simbad_name", sorter:"string", headerFilter: "input",editor:"input"},
        {title: "WXT Name", field: "wxt_name", sorter:"string", headerFilter: "input",editor:"input"},
        {title: "EP Name", field: "ep_name", sorter:"string", headerFilter: "input",editor:"input"},
        {title: "Comments", field: "comments", sorter:"string", headerFilter: "input",editor:"textarea",formatter:"textarea"},
        {title: "Flux", field: "flux", sorter:"number", headerFilter: "number",editor:"number"},
        {title: "Ref Flux", field: "known_flux", sorter:"number", headerFilter: "number",editor:"number"},
        
        {title: "Ref RA(J2000)", field: "r_ra", sorter:"number"},
        {title: "Ref Dec(J2000)", field: "r_dec", sorter:"number"},
        {title: "Sep", field: "r_sep", sorter:"number"},

        // {title: "Ratio_Flux",field:"ratio_flux",sorter:"number"},
        // {title: "Frac_Flux",field:"frac_flux",sorter:"number"},
        // {title: "AI_Classification", field: "ai_classification", sorter:"string", headerFilter: "input"},
        // {title: "AI_Prob", field: "ai_prob"},
        
        ],
        
    });

    function submitIdentificationIcon(cell, formatterParams, onRendered)
    {
      return '<i class="fas fa-save"></i>';
    }

   function deliver2fxtsysIcon(cell, formatterParams, onRendered)
   {
    return '<i class="fas fa-paper-plane"></i>';

   }
   function deliver2fxtsys(data)
   {
    $("#spinner-div").show();
    //将证认结果发送给FXT分系统
    $.ajax({
            url:'{{url_for(".fxt_classify_send_api")}}',
            type:"POST",
            data:{
              fxt_name: data['fxt_name'], // should be fxt_name
              version: data['src_name'],
              identified_name: data['simbad_name'],
              types: data['type'],
              ref_flux : data['known_flux'],
              classification : data['classification'],
              comments : data['comments'],
              ep_name:data['ep_name'],
              wxt_name:data['wxt_name']
            },
            success:function(result){
                alert("Send to FXT Sytem Successful!")
                $("#spinner-div").hide();
            },
            error: function(xhr,status,error){
                
            }
        });
   }

    function submitIdentification(data)
    {
      $("#spinner-div").show();
        src_id = data.so_id //获取的是对应的sourceobservtion中的id
        src_type = data['type']
        simbad_name =  data['simbad_name']
        classification = data['classification']
        comments = data['comments']
        ref_flux = data['known_flux']
        wxt_name = data['wxt_name']
        ep_name = data['ep_name'] //should be ep_name
        fxt_name = data['fxt_name'] //should be fxt_name
  

        console.log(src_id)
        // 如果填入了known_source/burst，必须有simbad_name
        if ((src_type=="known_source" || src_type=="burst") && !simbad_name){
            return
        }

        $.ajax({
            url:'{{url_for(".ta_update")}}',
            type:"POST",
            data:{
                src_id,
                "type": src_type,
                classification,
                simbad_name,
                comments,
                ref_flux,
                wxt_name,
                fxt_name,
                ep_name,
                instrument:"fxt"
            },
            success:function(result){
                alert("Submit Identificaiton Success.")
                $("#spinner-div").hide();
            },
            error: function(xhr,status,error){
                
            }
        });
    }

    table.on("rowSelected", function(row) {
            showRecords(row.getData().records);
    })
    table.setFilter("type", "!=", "known_source"); 

    // 动态加载长耗时操作
    // for (data_item of data){
    //     $.ajax({
    //         url:'{{url_for(".wxt_so_detail_api",so_id="SO_ID")}}'.replace("SO_ID",data_item.id),
    //         success:(resp)=>{
    //             ratio_flux = resp['ratio_flux']
    //             frac_flux = resp['frac_flux']
    //             if (typeof ratio_flux === 'number') {
    //                 ratio_flux = ratio_flux.toFixed(3);
    //             }
    //             if (typeof ratio_flux === 'number') {
    //                 ratio_flux = (ratio_flux*100).toFixed(3);
    //             }
    //             table.updateData([{
    //                 id:resp.id,
    //                 "ratio_flux":ratio_flux,
    //                 "frac_flux":frac_flux,
    //             }])
    //         }
    //     })
    // }
</script>

<!--第二个表格：证认记录相关代码（已迁移到ta_record.html）-->

{% endblock%}